{"is_source_file": true, "format": "Python", "description": "This file manages a FAISS index for chunk embeddings used in similarity search within a document database. It handles creating, loading, persisting, and rebuilding the index, as well as adding embeddings and performing searches.", "external_files": ["faiss", "numpy", "../models", ".config"], "external_methods": ["faiss.read_index", "faiss.write_index"], "published": ["get_faiss_index", "ensure_index_in_sync", "upsert_chunk_embedding"], "classes": [{"name": "FaissIndex", "description": "A class managing a FAISS index for cosine similarity search over chunk embeddings, including creation, loading, saving, normalization, and rebuilding."}], "methods": [{"name": "__init__(self, dim: int, index_path: str, map_path: Optional[str] = None)", "description": "Initializes the FaissIndex with specified dimensions and index/map paths, and loads or creates the index.", "scope": "FaissIndex", "scopeKind": "class"}, {"name": "_create_index(self)", "description": "Creates a new FAISS IndexFlatIP for cosine similarity with normalized vectors.", "scope": "FaissIndex", "scopeKind": "class"}, {"name": "_load_or_create(self)", "description": "Loads an existing index and mapping from disk if available, otherwise creates new ones, ensuring consistency.", "scope": "FaissIndex", "scopeKind": "class"}, {"name": "_persist(self)", "description": "Saves the current FAISS index and id map to disk.", "scope": "FaissIndex", "scopeKind": "class"}, {"name": "np.ndarray _normalize(self, vecs: np.ndarray)", "description": "Normalizes vectors to unit length for cosine similarity.", "scope": "FaissIndex", "scopeKind": "class"}, {"name": "rebuild_from_db(self)", "description": "Rebuilds the FAISS index from all Embedding records in the database, normalizing vectors.", "scope": "FaissIndex", "scopeKind": "class"}, {"name": "add_embeddings(self, chunk_ids: List[int], vectors: List[List[float]])", "description": "Adds new embeddings to the index and updates the id map.", "scope": "FaissIndex", "scopeKind": "class"}, {"name": "List[Tuple[int,float]] search(self, query_vector: List[float], top_k: int = 5)", "description": "Performs a similarity search with a query vector, returning top-k matching chunk IDs with scores.", "scope": "FaissIndex", "scopeKind": "class"}, {"name": "ensure_index_in_sync()", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "FaissIndex get_faiss_index()", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "upsert_chunk_embedding(chunk: DocumentChunk, vector: List[float], model: str, dim: int)", "scope": "", "scopeKind": "", "description": "unavailable"}], "calls": ["faiss.read_index", "faiss.write_index", "json.load", "json.dump", "np.linalg.norm", "Embedding.objects.all", "Embedding.objects.update_or_create", "transaction.atomic"], "search-terms": ["FAISS index", "chunk embeddings", "rebuild index from database", "vector normalization", "add embeddings", "similarity search"], "state": 2, "file_id": 22, "knowledge_revision": 76, "git_revision": "8c501e32b9060d2803a95c7b6ecfa4f7be04b5ad", "revision_history": [{"46": ""}, {"76": "8c501e32b9060d2803a95c7b6ecfa4f7be04b5ad"}], "ctags": [{"_type": "tag", "name": "FaissIndex", "path": "/home/kavia/workspace/code-generation/company-data-qa-platform-2984-2993/qanda_backend/api/services/faiss_index.py", "pattern": "/^class FaissIndex:$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "__init__", "path": "/home/kavia/workspace/code-generation/company-data-qa-platform-2984-2993/qanda_backend/api/services/faiss_index.py", "pattern": "/^    def __init__(self, dim: int, index_path: str, map_path: Optional[str] = None):$/", "language": "Python", "kind": "member", "signature": "(self, dim: int, index_path: str, map_path: Optional[str] = None)", "scope": "FaissIndex", "scopeKind": "class"}, {"_type": "tag", "name": "_create_index", "path": "/home/kavia/workspace/code-generation/company-data-qa-platform-2984-2993/qanda_backend/api/services/faiss_index.py", "pattern": "/^    def _create_index(self):$/", "language": "Python", "kind": "member", "signature": "(self)", "scope": "FaissIndex", "scopeKind": "class"}, {"_type": "tag", "name": "_faiss_instance", "path": "/home/kavia/workspace/code-generation/company-data-qa-platform-2984-2993/qanda_backend/api/services/faiss_index.py", "pattern": "/^_faiss_instance: Optional[FaissIndex] = None$/", "language": "Python", "typeref": "typename:Optional[FaissIndex]", "kind": "variable"}, {"_type": "tag", "name": "_load_or_create", "path": "/home/kavia/workspace/code-generation/company-data-qa-platform-2984-2993/qanda_backend/api/services/faiss_index.py", "pattern": "/^    def _load_or_create(self):$/", "language": "Python", "kind": "member", "signature": "(self)", "scope": "FaissIndex", "scopeKind": "class"}, {"_type": "tag", "name": "_normalize", "path": "/home/kavia/workspace/code-generation/company-data-qa-platform-2984-2993/qanda_backend/api/services/faiss_index.py", "pattern": "/^    def _normalize(self, vecs: np.ndarray) -> np.ndarray:$/", "language": "Python", "typeref": "typename:np.ndarray", "kind": "member", "signature": "(self, vecs: np.ndarray)", "scope": "FaissIndex", "scopeKind": "class"}, {"_type": "tag", "name": "_persist", "path": "/home/kavia/workspace/code-generation/company-data-qa-platform-2984-2993/qanda_backend/api/services/faiss_index.py", "pattern": "/^    def _persist(self):$/", "language": "Python", "kind": "member", "signature": "(self)", "scope": "FaissIndex", "scopeKind": "class"}, {"_type": "tag", "name": "add_embeddings", "path": "/home/kavia/workspace/code-generation/company-data-qa-platform-2984-2993/qanda_backend/api/services/faiss_index.py", "pattern": "/^    def add_embeddings(self, chunk_ids: List[int], vectors: List[List[float]]):$/", "language": "Python", "kind": "member", "signature": "(self, chunk_ids: List[int], vectors: List[List[float]])", "scope": "FaissIndex", "scopeKind": "class"}, {"_type": "tag", "name": "ensure_index_in_sync", "path": "/home/kavia/workspace/code-generation/company-data-qa-platform-2984-2993/qanda_backend/api/services/faiss_index.py", "pattern": "/^def ensure_index_in_sync():$/", "language": "Python", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "get_faiss_index", "path": "/home/kavia/workspace/code-generation/company-data-qa-platform-2984-2993/qanda_backend/api/services/faiss_index.py", "pattern": "/^def get_faiss_index() -> FaissIndex:$/", "language": "Python", "typeref": "typename:FaissIndex", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "np", "path": "/home/kavia/workspace/code-generation/company-data-qa-platform-2984-2993/qanda_backend/api/services/faiss_index.py", "pattern": "/^import numpy as np  # type: ignore$/", "language": "Python", "kind": "namespace", "nameref": "module:numpy"}, {"_type": "tag", "name": "rebuild_from_db", "path": "/home/kavia/workspace/code-generation/company-data-qa-platform-2984-2993/qanda_backend/api/services/faiss_index.py", "pattern": "/^    def rebuild_from_db(self):$/", "language": "Python", "kind": "member", "signature": "(self)", "scope": "FaissIndex", "scopeKind": "class"}, {"_type": "tag", "name": "search", "path": "/home/kavia/workspace/code-generation/company-data-qa-platform-2984-2993/qanda_backend/api/services/faiss_index.py", "pattern": "/^    def search(self, query_vector: List[float], top_k: int = 5) -> List[Tuple[int, float]]:$/", "language": "Python", "typeref": "typename:List[Tuple[int,float]]", "kind": "member", "signature": "(self, query_vector: List[float], top_k: int = 5)", "scope": "FaissIndex", "scopeKind": "class"}, {"_type": "tag", "name": "upsert_chunk_embedding", "path": "/home/kavia/workspace/code-generation/company-data-qa-platform-2984-2993/qanda_backend/api/services/faiss_index.py", "pattern": "/^def upsert_chunk_embedding(chunk: DocumentChunk, vector: List[float], model: str, dim: int):$/", "language": "Python", "kind": "function", "signature": "(chunk: DocumentChunk, vector: List[float], model: str, dim: int)"}], "hash": "4c5a36951b77fb83fe5dd1bf1a5c7eaa", "format-version": 4, "code-base-name": "qanda_backend", "filename": "qanda_backend/api/services/faiss_index.py", "fields": [{"name": "Optional[FaissIndex] _faiss_instance", "scope": "", "scopeKind": "", "description": "unavailable"}]}